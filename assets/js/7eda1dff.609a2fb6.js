"use strict";(self.webpackChunkbunker=self.webpackChunkbunker||[]).push([[6845],{3699:(e,t,r)=>{r.d(t,{R:()=>s});var a=r(5286);async function s(e,t){void 0===t&&(t={});const{data:{session:r}}=await a.N.auth.getSession(),s=r?.user?.id??null,{error:n}=await a.N.from("site_events").insert({user_id:s,event_type:e,payload:t});n&&console.error("Log error:",n)}},4448:(e,t,r)=>{r.d(t,{Rf:()=>o,r1:()=>i});var a=r(5286),s=r(3699);async function n(e,t,r){void 0===t&&(t="token"),void 0===r&&(r="");const{data:{session:n},error:o}=await a.N.auth.getSession();if(o||!n?.user)throw new Error("Not authenticated");const{error:i}=await a.N.rpc("rpc_modify_tokens",{_user:n.user.id,_amount:e,_token_type:t,_reason:r});if(i)throw i;await(0,s.R)("token_transaction",{type:t,amount:e,reason:r})}async function o(e,t,r){return void 0===t&&(t="token"),void 0===r&&(r="spent"),n(-Math.abs(e),t,r)}async function i(e){void 0===e&&(e="token");const{data:{session:t},error:r}=await a.N.auth.getSession();if(r||!t?.user)throw new Error("Not authenticated");const{data:s,error:n,status:o}=await a.N.from("characters").select("tokens_json").eq("user_id",t.user.id).maybeSingle();if(n&&406!==o)throw n;return parseInt((s?.tokens_json??{})[e]??0,10)}},4610:(e,t,r)=>{r.d(t,{CE:()=>n,gi:()=>o,t9:()=>i});var a=r(5286);const s=0;async function n(){const{data:{session:e}}=await a.N.auth.getSession(),t=e?.user;if(!t)throw new Error("Not authenticated");const{data:r,error:n}=await a.N.from("characters").select().eq("user_id",t.id).maybeSingle();if(n)throw console.error("[character] Fetch error:",n.message),n;if(r)return r;const o=String(Math.floor(1e5+9e5*Math.random())),{data:i,error:c}=await a.N.from("characters").insert({user_id:t.id,user_id_number:o,self:s,tokens_json:{token:0}}).select().single();if(c)throw console.error("[character] Insert error:",c.message),c;return i}async function o(){const{data:{session:e}}=await a.N.auth.getSession(),t=e?.user;if(!t)throw new Error("Not authenticated");const{data:r,error:s}=await a.N.from("characters").select().eq("user_id",t.id).maybeSingle();if(s)throw console.error("[character] Get error:",s.message),s;return r}async function i(e){const{data:{session:t}}=await a.N.auth.getSession(),r=t?.user;if(!r)throw new Error("Not authenticated");const{data:s,error:n}=await a.N.from("characters").update(e).eq("user_id",r.id).select().single();if(n)throw n;return s}},5541:(e,t,r)=>{r.d(t,{T:()=>o,s:()=>n});var a=r(5286),s=r(3699);async function n(e){const{data:{session:t},error:r}=await a.N.auth.getSession();if(r||!t?.user)throw new Error("Not authenticated");const{data:s,error:n}=await a.N.from("unlocks").select("unlocked").eq("user_id",t.user.id).eq("feature_key",e).maybeSingle();if(n)throw n;return s?.unlocked??!1}async function o(e,t){void 0===t&&(t={});const{data:{session:r},error:o}=await a.N.auth.getSession();if(o||!r?.user)throw new Error("Not authenticated");if(await n(e))return!0;const{error:i}=await a.N.from("unlocks").insert({user_id:r.user.id,feature_key:e,unlocked:!0,payload:t});if(i)throw i;return await(0,s.R)("unlock",{feature_key:e,payload:t}),!0}},5599:(e,t,r)=>{r.d(t,{A:()=>s});r(6540);var a=r(4848);function s(e){let{self:t=0}=e;return(0,a.jsx)("pre",{className:"bg-[#f4f4f4] border border-gray-200 rounded-lg p-4 text-sm leading-6",children:`self (${t.toFixed(1)})\n\u251c\u2500 mental    [fogged]\n\u2514\u2500 physical  [fogged]`})}},8656:(e,t,r)=>{r.r(t),r.d(t,{default:()=>x});var a=r(6540),s=r(1410),n=r(9030),o=r(5286),i=r(4610),c=r(4848);function l(){return(0,c.jsx)("div",{style:{textAlign:"center",padding:"2rem"},children:(0,c.jsx)("p",{children:"Loading\u2026"})})}var u=r(2925);const d=e=>{let{steps:t}=e;const[r,s]=(0,a.useState)(null);return(0,a.useEffect)((()=>{if(!t?.length)return;const e=new u.A.Tour({defaultStepOptions:{cancelIcon:{enabled:!0},scrollTo:{behavior:"smooth",block:"center"},classes:"shepherd-theme-arrows"},useModalOverlay:!0});return t.forEach(((r,a)=>{e.addStep({...r,buttons:[...a>0?[{text:"Back",action:e.back}]:[],...a<t.length-1?[{text:"Next",action:e.next}]:[{text:"Done",action:e.complete}]]})})),s(e),window.profileTour=e,localStorage.getItem("tour-profile-seen")||(e.start(),localStorage.setItem("tour-profile-seen","true")),()=>e.cancel()}),[t]),null};var h=r(9508),f=r(5599),m=r(5541);const b=()=>String(Math.floor(1e5+9e5*Math.random()));function x(){const[e,t]=(0,a.useState)(null),[r,u]=(0,a.useState)(null),[x,g]=(0,a.useState)(!0),[w,p]=(0,a.useState)(null),[y,N]=(0,a.useState)(""),[k,v]=(0,a.useState)(""),[_,j]=(0,a.useState)(null),[S,E]=(0,a.useState)(!1),[C,A]=(0,a.useState)(!1),[T,I]=(0,a.useState)(!1),q=(0,n.Ay)("/timeline/origin"),D=(0,n.Ay)("/profile/development");(0,a.useEffect)((()=>{(async()=>{const{data:e}=await o.N.auth.getSession();t(e?.session||null)})();const{data:e}=o.N.auth.onAuthStateChange(((e,r)=>t(r)));return()=>e.subscription.unsubscribe()}),[]),(0,a.useEffect)((()=>{e&&(async()=>{try{let e=await(0,i.gi)();if(e||(await(0,i.CE)(),e=await(0,i.gi)()),!e.user_id_number){const t=b();await(0,i.t9)({user_id_number:t}),e.user_id_number=t}u(e),A(await(0,m.s)("self_revealed")),I(await(0,m.s)("symbol_tree_revealed"))}catch(e){p(e.message)}finally{g(!1)}})()}),[e]),(0,a.useEffect)((()=>{r?.user_id_number&&N(r.user_id_number)}),[r]),(0,a.useEffect)((()=>{x||w||!r||E(!0)}),[x,w,r]);return e?x?(0,c.jsx)(s.A,{title:"Identity Center",children:(0,c.jsx)("div",{className:"flex justify-center mt-12",children:(0,c.jsx)(l,{})})}):w?(0,c.jsx)(s.A,{title:"Identity Center",children:(0,c.jsxs)("p",{className:"text-center text-red-600 mt-12 text-lg",children:["Error: ",w]})}):(0,c.jsxs)(s.A,{title:"Identity Center",children:[S&&(0,c.jsx)(d,{steps:[{attachTo:{element:'[data-tour="action-bar"]',on:"bottom"},title:"Profile Navigation",text:["Use these buttons to progress or replay the tour."]},{attachTo:{element:'[data-tour="id-number"]',on:"right"},title:"Your ID Number",text:["This is your unique 6\u2011digit identifier."]},{attachTo:{element:'[data-tour="token-display"]',on:"bottom"},title:"Token Balance",text:["Your current token count is shown here."]},{attachTo:{element:'[data-tour="show-tour"]',on:"bottom"},title:"Show Tour Again",text:["Replay this tutorial any time."]}]}),(0,c.jsxs)("main",{className:"max-w-3xl mx-auto px-6 pt-12 pb-20 space-y-12",children:[(0,c.jsxs)("div",{className:"text-right mb-4 flex items-center justify-end space-x-2","data-tour":"action-bar",children:[(0,c.jsx)("button",{className:"btn btn-outline",onClick:()=>window.location.href=q,children:"\ud83d\udcd8 Continue Narrative"}),(0,c.jsx)("button",{className:"btn btn-outline",onClick:()=>window.location.href=D,children:"\ud83d\udcd8 Go to Character Development"}),(0,c.jsx)("button",{className:"btn btn-outline","data-tour":"show-tour",onClick:()=>{localStorage.removeItem("tour-profile-seen"),window.profileTour?.start()},children:"\ud83d\udcd8 Show Tour Again"})]}),(0,c.jsx)("h1",{className:"text-4xl font-extrabold tracking-tight",children:"User Profile"}),(0,c.jsxs)("section",{className:"bg-[#fdfcf5] border border-gray-200 shadow-md rounded-xl p-6 space-y-4","data-tour":"id-number",children:[(0,c.jsx)("h2",{className:"text-xl font-semibold border-b pb-2",children:"Your ID Number"}),(0,c.jsxs)("div",{className:"flex flex-wrap gap-2 items-center",children:[(0,c.jsx)("input",{className:"input flex-grow min-w-[140px]",value:y,onChange:e=>N(e.target.value),placeholder:"6\u2011digit number"}),(0,c.jsx)("button",{className:"btn btn-info",onClick:async()=>{if(!/^[0-9]{6}$/.test(y))return j(!1),void v("Enter a valid 6\u2011digit number.");const{data:e,error:t}=await o.N.from("characters").select("id").eq("user_id_number",y);if(t)return j(!1),void v("Error checking availability.");const a=e.some((e=>e.id!==r.id));j(!a),v(a?"Number already in use.":"Number is available!")},children:"Check"}),(0,c.jsx)("button",{className:"btn btn-primary disabled:opacity-50",disabled:!_,onClick:async()=>{if(_)try{await(0,i.t9)({user_id_number:y}),v("ID saved.")}catch{v("Save failed, try again.")}},children:"Save ID"})]}),k&&(0,c.jsx)("p",{className:_?"success-message":"error-message",children:k})]}),(0,c.jsx)("section",{"data-tour":"token-display",children:(0,c.jsx)(h.A,{type:"token"})}),C&&(0,c.jsxs)("section",{className:"bg-[#fdfcf5] border border-gray-200 shadow-md rounded-xl p-6 space-y-4",children:[(0,c.jsx)("h2",{className:"text-xl font-semibold border-b pb-2",children:"Self Development"}),(0,c.jsxs)("p",{children:["Self: ",(0,c.jsx)("strong",{children:r.self?.toFixed(1)})]}),T&&(0,c.jsxs)("div",{className:"mt-6",children:[(0,c.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Symbol Tree"}),(0,c.jsx)(f.A,{self:r.self})]})]})]})]}):(0,c.jsx)(s.A,{title:"Identity Center",children:(0,c.jsx)("p",{className:"text-center mt-12 text-lg",children:"\u26a0\ufe0f Please sign in first."})})}},9508:(e,t,r)=>{r.d(t,{A:()=>o});var a=r(6540),s=r(4448),n=r(4848);function o(e){let{type:t="token"}=e;const[r,o]=(0,a.useState)(null),[i,c]=(0,a.useState)(!0);return(0,a.useEffect)((()=>{(0,s.r1)(t).then(o).catch((()=>o(null))).finally((()=>c(!1)))}),[t]),i?(0,n.jsx)("p",{children:"Loading tokens..."}):(0,n.jsxs)("div",{style:{fontWeight:"bold",marginBottom:"1rem"},children:["Tokens: ",r??0]})}}}]);